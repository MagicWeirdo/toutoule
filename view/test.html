<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>掷骰子</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/static/js/phaser.min.js"></script>
  <script src="/static/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/static/bower_components/js-cookie/src/js.cookie.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      background: #F44133;
    }

    #form {
      width: 206px;
    }

    .label {
      color: #000000;
      font-size: 16px;
      font-weight: bold;
    }

    .input-box {
      display: block;
      margin: 12px auto;
      border: 0;
      border-radius: 5px;
      padding: 6px;
      color: #000000;
      font-size: 16px;
      font-weight: bold;
    }

    .btn {
      padding: 6px;
      border: 0;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
  <script>
    $(document).ready(function() {
      if(Cookies.get("token") === undefined) {
        $("#form").append(
          "<label class=\"label\">用户名</label>" +
          "<input type=\"text\" id=\"username\" class=\"input-box\">" +
          "<label class=\"label\">密码</label>" +
          "<input type=\"password\" id=\"password\" class=\"input-box\">" +
          "<input type=\"button\" value=\"登录\" id=\"login-btn\" class=\"btn\">"
        );

        // center the form
        var form = $("#form");
        var height = form.outerHeight();
        form.css("margin", (window.innerHeight / 2 - height / 2) + "px" + " auto");

        // add click event
        $("#login-btn").click(function() {
          $.ajax({
            type: "POST",
            url: "/user/login",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
              username: $("#username").val(),
              password: $("#password").val()
            }),
            dataType: "json"
          }).then(function(data) {
            if(data.isError) {
              alert(data.errorMessage);
            }else {
              // save to the cookie
              Cookies.set("username", $("#username").val());
              Cookies.set("token", data.result.token);

              // check if it needs to modify password
              if($("#password").val() === "123456789") {
                $("#form").empty();

                // add change password form
                $("#form").append(
                  "<label class=\"label\">旧密码</label>" +
                  "<input type=\"password\" id=\"oldPassword\" class=\"input-box\">" +
                  "<label class=\"label\">新密码</label>" +
                  "<input type=\"password\" id=\"newPassword\" class=\"input-box\">" +
                  "<input type=\"button\" value=\"修改\" id=\"modify-btn\" class=\"btn\">"
                );

                // add click event
                $("#modify-btn").click(function() {
                  $.ajax({
                    type: "POST",
                    url: "/user/modifyPassword",
                    headers: {
                      "Authorization": Cookies.get("token")
                    },
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                      oldPassword: $("#oldPassword").val(),
                      newPassword: $("#newPassword").val()
                    }),
                    dataType: "json"
                  }).then(function(data) {
                    if(data.isError) {
                      alert(data.errorMessage);
                    }else {
                      $("#form").detach();

                      // bootstrap the game
                      bootstrap();
                    }
                  });
                });
              }else {
                $("#form").detach();

                // bootstrap the game
              }
            }
          });
        });
      }else {
        $("#form").detach();

        // bootstrap the game
        bootstrap();
      }
    });

    // bootstrap game
    function bootstrap() {
      // canvas container
      $("body").append("<div id=\"canvas\"></div>");

      // open WebSocket
      var socket = io();

      // create a game object
      var game = new Phaser.Game(
        window.innerWidth,
        window.innerHeight,
        Phaser.AUTO,
        "canvas",
        {
          preload: preload,
          create: create,
          update: update,
          render: render
        }
      );

      function preload() {
        game.load.image("dice", "/static/assets/dice-1.png");
      }

      function create() {

      }

      function update() {

      }

      function render() {

      }
    }
  </script>
</head>
<body>
  <div id="form"></div>
</body>
</html>
