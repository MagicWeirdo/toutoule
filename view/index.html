<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>骰骰乐</title>
  <style>
    * {
      margin: 0;
      border: 0;
      padding: 0;
    }

    html {
      width: 100%;
      height: 100%;
    }

    body {
      width: 100%;
      height: 100%;
    }

    .background {
      background-image: url("/static/images/bg.png");
    }

    #login-form, #forget-form {
      position: relative;
      top: 40%;
      margin-left: auto;
      margin-top: -150px;
      margin-right: auto;
      width: 300px;
      height: 320px;
      background-image: url("/static/images/box.png");
      background-repeat: no-repeat;
      background-position: center;
    }

    #wrapper {
      padding: 100px 0;
      width: 300px;
      height: 320px;
    }

    #username {
      display: block;
      margin: 0 auto 20px;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #password {
      display: block;
      margin: 20px auto 0;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #user {
      display: block;
      margin: 0 auto 20px;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #oldPassword {
      display: block;
      margin: 20px auto 20px;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #newPassword {
      display: block;
      margin: 20px auto 0;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #login-button {
      margin: 42px auto;
      width: 230px;
      height: 48px;
      background-image: url("/static/images/login.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #forget-button {
      float: right;;
      margin-top: 10px;
      width: 150px;
      height: 40px;
      background-image: url("/static/images/change.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #return-button {
      float: right;;
      margin-top: 20px;
      width: 150px;
      height: 40px;
      background-image: url("/static/images/back_button.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #change-button {
      margin: 10px auto;
      width: 230px;
      height: 48px;
      background-image: url("/static/images/change_button.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #ground {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 48px;
      background-image: url("/static/images/bottom.png");
      background-repeat: repeat-x;
      background-size: contain;
    }

    .dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      border: 1px solid #D8D8D8;
      border-radius: 10px;
      background: #FAFAFA;
    }

    .dialog-header {
      padding: 6px;
    }

    .close-button {
      float: right;
      width: 24px;
      height: 24px;
      background-image: url("/static/images/close.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    .dialog-body {
      clear: both;
      border-top: 1px solid #D8D8D8;
      padding: 24px;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/static/js/phaser.min.js"></script>
  <script src="/static/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/static/bower_components/js-cookie/src/js.cookie.js"></script>
  <script>
    $(document).ready(function() {
      bootstrap();
      // makeLoginForm();
    });

    // 生成登录框
    function makeLoginForm() {
      // 移除所有界面元素
      $("body").empty();

      $("body").addClass("background");
      $("body").append(
        "<div id=\"login-form\">" +
        "<div id=\"wrapper\">" +
        "<input type=\"text\" id=\"username\" placeholder=\"请输入用户名\">" +
        "<input type=\"password\" id=\"password\" placeholder=\"请输入密码\">" +
        "<div id=\"login-button\"></div>" +
        "<div id=\"forget-button\"></div>" +
        "</div>" +
        "</div>" +
        "<div id=\"ground\"></div>"
      );

      // 注册登录按钮点击事件
      $("#login-button").click(function() {
        $.post(
          "/user/login",
          JSON.stringify({
            username: $("#username").val(),
            password: $("#password").val()
          }),
          function(data) {
            if(data.isError) {
              makeDialog(data.errorMessage);
            }else {
              Cookies.set("username", $("#username").val());
              Cookies.set("token", data.result.token);

              bootstrap();
            }
          },
          "json"
        );
      });

      $("#forget-button").click(function() {
        makeForgetForm();
      });
    }

    // 生成修改密码框
    function makeForgetForm() {
      $("body").empty();

      $("body").addClass("background");
      $("body").append(
        "<div id=\"forget-form\">" +
        "<div id=\"wrapper\">" +
        "<input type=\"user\" id=\"user\" placeholder=\"请输入用户名\">" +
        "<input type=\"password\" id=\"oldPassword\" placeholder=\"请输入旧密码\">" +
        "<input type=\"password\" id=\"newPassword\" placeholder=\"请输入新密码\">" +
        "<div id=\"change-button\"></div>" +
        "<div id=\"return-button\"></div>" +
        "</div>" +
        "</div>" +
        "<div id=\"ground\"></div>"
      );

      $("#change-button").click(function() {
        $.post(
          "/user/modifyPassword",
          JSON.stringify({
            username: $("#user").val(),
            oldPassword: $("#oldPassword").val(),
            newPassword: $("#newPassword").val()
          }),
          function(data) {
            if(data.isError) {
              makeDialog(data.errorMessage);
            }else {
              makeLoginForm();
            }
          },
          "json"
        );
      });

      $("#return-button").click(function() {
        makeLoginForm()
      });
    }

    // 制作对话框
    function makeDialog(msg) {
      $("body").append(
        "<div class=\"dialog\">" +
        "<div class=\"dialog\-header\">" +
        "<div class=\"close\-button\"></div>" +
        "</div>" +
        "<div class=\"dialog\-body\">" +
        "<p>" + msg + "</p>" +
        "</div>"
      );

      $(".dialog").css("margin-top", 0 - $(".dialog").outerHeight() / 2);
      $(".dialog").css("margin-left", 0 - $(".dialog").outerWidth() / 2);
      $(".close-button").click(function() {
        $(".dialog").detach();
      });
    }

    // 启动游戏
    function bootstrap() {
      // 清除对话框
      $("body").empty();

      // 清除背景
      $("body").removeClass("background");

      // canvas container
      $("body").append("<div id=\"canvas\"></div>");

      // open WebSocket
      var socket = io();

      // emitting register message
      // socket.emit("register", JSON.stringify({
      //   username: Cookies.get("username"),
      //   token: Cookies.get("token")
      // }));

      // create a game object
      var game = new Phaser.Game(
        window.innerWidth,
        window.innerHeight,
        Phaser.AUTO,
        "canvas",
        {
          preload: preload,
          create: create,
          update: update,
          render: render
        }
      );

      var mainScene;
      var gameScene;

      function preload() {
        game.load.image("background", "/static/assets/background.png");
        game.load.image("usernameBar", "/static/assets/username.png");
        game.load.image("coinBar", "/static/assets/coin.png");
        game.load.image("timeBar", "/static/assets/time.png");
        game.load.image("bulletinBar", "/static/assets/bulletin.png");
        game.load.image("buttonGroupBackground", "/static/assets/btn_bg.png");
        game.load.image("readyButton", "/static/assets/ready.png");
        game.load.image("cancelButton", "/static/assets/cancel.png");
        game.load.image("playArea", "/static/assets/play_area.png");
        game.load.image("stackArea", "/static/assets/stack_area.png");
        game.load.image("baozi", "/static/assets/baozi.png");
        game.load.image("dan", "/static/assets/dan.png");
        game.load.image("shuang", "/static/assets/shuang.png");
        game.load.image("money5", "/static/assets/5.png");
        game.load.image("money10", "/static/assets/10.png");
        game.load.image("money20", "/static/assets/20.png");
        game.load.image("money50", "/static/assets/50.png");
        game.load.image("input", "/static/assets/input.png");
        game.load.image("yes", "/static/assets/queding.png");
        game.load.image("back", "/static/assets/back.png");
        game.load.image("message", "/static/assets/message.png");
      }

      function create() {
        createMainScene();
      }

      function update() {

      }

      function render() {

      }

      // create main scene
      function createMainScene() {
        if(gameScene) {
          gameScene.destroy();
        }

        var displayWidth = window.innerWidth;
        var displayHeight = window.innerHeight;

        // main scene
        mainScene = game.add.group();
        mainScene.x = 0;
        mainScene.y = 0;
        mainScene.z = 0;

        var totalHeight = 0;

        // background
        var backgroundImage = game.add.image(0, 0, "background");
        backgroundImage.width = displayWidth;
        backgroundImage.height = displayHeight;
        mainScene.add(backgroundImage);

        // header group
        var headerGroup = game.add.group(mainScene);
        headerGroup.x = 0;
        headerGroup.y = 0;
        headerGroup.z = 0;

        // username group
        var usernameGroup = game.add.group(headerGroup);
        usernameGroup.x = 12;
        usernameGroup.y = 12;
        usernameGroup.z = 0;

        // username bar
        var usernameBar = game.add.image(0, 0, "usernameBar");
        usernameBar.width = displayWidth * 0.3;
        usernameBar.height = usernameBar.width / (228 / 65);
        usernameGroup.add(usernameBar);

        // username text
        var usernameText = game.add.text(usernameBar.width * 0.35, usernameBar.height * 0.3, "20170414", {
          fill: "#FFFFFF",
          fontSize: usernameBar.height * 0.4 + "px"
        });
        usernameGroup.add(usernameText);

        // coin group
        var coinGroup = game.add.group(headerGroup);
        coinGroup.x = displayWidth * 0.7 - 12;
        coinGroup.y = 12;
        coinGroup.z = 0;

        // coin bar
        var coinBar = game.add.image(0, 0, "coinBar");
        coinBar.width = displayWidth * 0.3;
        coinBar.height = coinBar.width / (250 / 68);
        coinGroup.add(coinBar);

        // coin text
        var coinText = game.add.text(coinBar.width * 0.35, coinBar.height * 0.3, "10000", {
          fill: "#FFFFFF",
          fontSize: coinBar.height * 0.4 + "px"
        });
        coinGroup.add(coinText);

        totalHeight += coinBar.height + 12;

        // time group
        var timeGroup = game.add.group(mainScene);
        timeGroup.x = (displayWidth * 0.5) / 2;
        timeGroup.y = totalHeight + 12;
        timeGroup.z = 0;

        // time bar
        var timeBar = game.add.image(0, 0, "timeBar");
        timeBar.width = displayWidth * 0.5;
        timeBar.height = timeBar.width / (445 / 113);
        timeGroup.add(timeBar);

        // time text
        var timeText = game.add.text((timeBar.width * 0.2) / 2, (timeBar.height * 0.75) / 2, "距离下一轮游戏开始还有5:00", {
          fill: "#FFFFFF",
          fontSize: timeBar.height * 0.25 + "px"
        });
        timeGroup.add(timeText);

        totalHeight += timeBar.height + 12;

        // bulletin group
        var bulletinGroup = game.add.group(mainScene);
        bulletinGroup.x = (displayWidth * 0.4) / 2;
        bulletinGroup.y = totalHeight + 12;
        bulletinGroup.z = 0;

        // bulletin bar
        var bulletinBar = game.add.image(0, 0, "bulletinBar");
        bulletinBar.width = displayWidth * 0.6;
        bulletinBar.height = bulletinBar.width / (525 / 750);
        bulletinGroup.add(bulletinBar);

        totalHeight += bulletinBar.height + 12;

        // button group
        var buttonGroup = game.add.group(mainScene);
        buttonGroup.x = 0;
        buttonGroup.y = totalHeight;
        buttonGroup.z = 0;

        // button background
        var buttonGroupBackground = game.add.image((displayWidth * 0.6) / 2, 0 - (((displayWidth * 0.4) / (420 / 109)) / 2), "buttonGroupBackground");
        buttonGroupBackground.width = displayWidth * 0.4;
        buttonGroupBackground.height = buttonGroupBackground.width / (420 / 109);
        buttonGroup.add(buttonGroupBackground);

        // ready button
        var readyButton = game.add.button((displayWidth * 0.6) / 2 + 2, 0 - (((displayWidth * 0.2) / (207 / 100)) / 2), "readyButton");
        readyButton.width = displayWidth * 0.2;
        readyButton.height = readyButton.width / (207 / 100);
        buttonGroup.add(readyButton);

        // cancel button
        var cancelButton = game.add.button((displayWidth * 0.6) / 2 + readyButton.width - 2, 0 - (((displayWidth * 0.2) / (207 / 100)) / 2), "cancelButton");
        cancelButton.width = displayWidth * 0.2;
        cancelButton.height = cancelButton.width / (207 / 100);
        buttonGroup.add(cancelButton);
      }

      // create game scene
      function createGameScene() {
        if(mainScene) {
          mainScene.destroy();
        }

        var displayWidth = window.innerWidth;
        var displayHeight = window.innerHeight;

        // game scene
        gameScene = game.add.group();
        gameScene.x = 0;
        gameScene.y = 0;
        gameScene.z = 0;

        var totalHeight = 0;

        // background
        var backgroundImage = game.add.image(0, 0, "background");
        backgroundImage.width = displayWidth;
        backgroundImage.height = displayHeight;
        gameScene.add(backgroundImage);

        // header group
        var headerGroup = game.add.group(gameScene);
        headerGroup.x = 0;
        headerGroup.y = 0;
        headerGroup.z = 0;

        // username bar
        var usernameBar = game.add.image(12, 12, "usernameBar");
        usernameBar.width = displayWidth * 0.3;
        usernameBar.height = usernameBar.width / (228 / 65);
        headerGroup.add(usernameBar);

        // coin bar
        var coinBar = game.add.image(displayWidth * 0.7 - 12, 12, "coinBar");
        coinBar.width = displayWidth * 0.3;
        coinBar.height = coinBar.width / (250 / 68);
        headerGroup.add(coinBar);

        totalHeight += coinBar.height + 12;

        // play area
        var playArea = game.add.image((displayWidth * 0.4) / 2, totalHeight + displayHeight * 0.1, "playArea");
        playArea.width = displayWidth * 0.6;
        playArea.height = playArea.width / (583 / 410);
        gameScene.add(playArea);

        totalHeight += playArea.height + displayHeight * 0.1;

        // stack group
        var stackGroup = game.add.group(gameScene);
        stackGroup.x = 0;
        stackGroup.y = totalHeight + 12;
        stackGroup.z = 0;

        // stack area
        var stackArea = game.add.image((displayWidth * 0.1) / 2, 0, "stackArea");
        stackArea.width = displayWidth * 0.9;
        stackArea.height = stackArea.width / (677 / 291);
        stackGroup.add(stackArea);

        // choice group
        var choiceGroup = game.add.group(stackGroup);
        choiceGroup.x = displayWidth * 0.05;
        choiceGroup.y = stackArea.height * (93 / 291);
        choiceGroup.z = 0;

        // baozi button
        var baoziButton = game.add.button(displayWidth * 0.05, 0, "baozi");
        baoziButton.width = displayWidth * 0.25;
        baoziButton.height = baoziButton.width / (188 / 70);
        choiceGroup.add(baoziButton);

        // dan button
        var danButton = game.add.button(baoziButton.width + displayWidth * 0.075, 0, "dan");
        danButton.width = displayWidth * 0.25;
        danButton.height = danButton.width / (188 / 70);
        choiceGroup.add(danButton);

        // shuang button
        var shuangButton = game.add.button(baoziButton.width + danButton.width + displayWidth * 0.1, 0, "shuang");
        shuangButton.width = displayWidth * 0.25;
        shuangButton.height = shuangButton.width / (188 / 70);
        choiceGroup.add(shuangButton);

        // money group
        var moneyGroup = game.add.group(stackGroup);
        moneyGroup.x = displayWidth * 0.05;
        moneyGroup.y = stackArea.height * (93 / 291) + shuangButton.height + 5;
        moneyGroup.z = 0;

        // money 5
        var money5Button = game.add.button(displayWidth * 0.05, 0, "money5");
        money5Button.width = displayWidth * 0.1;
        money5Button.height = money5Button.width / (59 / 62);
        moneyGroup.add(money5Button);

        // money 10
        var money10Button = game.add.button(money5Button.width + displayWidth * 0.05, 0, "money10");
        money10Button.width = displayWidth * 0.1;
        money10Button.height = money10Button.width / (59 / 62);
        moneyGroup.add(money10Button);

        // money 20
        var money20Button = game.add.button(money5Button.width + money10Button.width + displayWidth * 0.05, 0, "money20");
        money20Button.width = displayWidth * 0.1;
        money20Button.height = money20Button.width / (59 / 63);
        moneyGroup.add(money20Button);

        // money 50
        var money50Button = game.add.button(money5Button.width + money10Button.width + money20Button.width + displayWidth * 0.05, 0, "money50");
        money50Button.width = displayWidth * 0.1;
        money50Button.height = money50Button.width / (58 / 61);
        moneyGroup.add(money50Button);

        // input bar
        var inputBar = game.add.image(displayWidth * 0.9 - (money5Button.width + money10Button.width + money20Button.width + displayWidth * 0.1), 0, "input");
        inputBar.width = displayWidth * 0.35;
        inputBar.height = inputBar.width / (239 / 71);
        moneyGroup.add(inputBar);

        totalHeight += stackArea.height + 12;

        // yes button
        var yesButton = game.add.button(displayWidth * 0.35, totalHeight - displayWidth * 0.05, "yes");
        yesButton.width = displayWidth * 0.3;
        yesButton.height = yesButton.width / (200 / 61);

        // back button
        var backButton = game.add.button(displayWidth * 0.1, displayHeight * 0.9, "back");
        backButton.width = displayWidth * 0.1;
        backButton.height = backButton.width / (79 / 81);
      }
    }
  </script>
</head>
<body>
</body>
</html>
