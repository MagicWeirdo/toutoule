<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>骰骰乐</title>
  <style>
    * {
      margin: 0;
      border: 0;
      padding: 0;
    }

    html {
      width: 100%;
      height: 100%;
    }

    body {
      width: 100%;
      height: 100%;
    }

    .background {
      background-image: url("/static/images/bg.png");
    }

    #login-form, #forget-form {
      position: relative;
      top: 40%;
      margin-left: auto;
      margin-top: -150px;
      margin-right: auto;
      width: 300px;
      height: 320px;
      background-image: url("/static/images/box.png");
      background-repeat: no-repeat;
      background-position: center;
    }

    #wrapper {
      padding: 100px 0;
      width: 300px;
      height: 320px;
    }

    #username {
      display: block;
      margin: 0 auto 20px;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #password {
      display: block;
      margin: 20px auto 0;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #user {
      display: block;
      margin: 0 auto 20px;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #oldPassword {
      display: block;
      margin: 20px auto 20px;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #newPassword {
      display: block;
      margin: 20px auto 0;
      border-radius: 10px;
      border: 1px solid #BC9057;
      padding: 0 10px;
      width: 228px;
      height: 32px;
      font-size: 16px;
    }

    #login-button {
      margin: 42px auto;
      width: 230px;
      height: 48px;
      background-image: url("/static/images/login.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #forget-button {
      float: right;;
      margin-top: 10px;
      width: 150px;
      height: 40px;
      background-image: url("/static/images/change.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #return-button {
      float: right;;
      margin-top: 20px;
      width: 150px;
      height: 40px;
      background-image: url("/static/images/back_button.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #change-button {
      margin: 10px auto;
      width: 230px;
      height: 48px;
      background-image: url("/static/images/change_button.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    #ground {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 48px;
      background-image: url("/static/images/bottom.png");
      background-repeat: repeat-x;
      background-size: contain;
    }

    .dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      border: 1px solid #D8D8D8;
      border-radius: 10px;
      background: #FAFAFA;
    }

    .dialog-header {
      padding: 6px;
    }

    .close-button {
      float: right;
      width: 24px;
      height: 24px;
      background-image: url("/static/images/close.png");
      background-repeat: no-repeat;
      background-size: contain;
      cursor: pointer;
    }

    .dialog-body {
      clear: both;
      border-top: 1px solid #D8D8D8;
      padding: 24px;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/static/js/phaser.min.js"></script>
  <script src="/static/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/static/bower_components/js-cookie/src/js.cookie.js"></script>
  <script>
    $(document).ready(function() {
      bootstrap();
      // makeLoginForm();
    });

    // 生成登录框
    function makeLoginForm() {
      // 移除所有界面元素
      $("body").empty();

      $("body").addClass("background");
      $("body").append(
        "<div id=\"login-form\">" +
        "<div id=\"wrapper\">" +
        "<input type=\"text\" id=\"username\" placeholder=\"请输入用户名\">" +
        "<input type=\"password\" id=\"password\" placeholder=\"请输入密码\">" +
        "<div id=\"login-button\"></div>" +
        "<div id=\"forget-button\"></div>" +
        "</div>" +
        "</div>" +
        "<div id=\"ground\"></div>"
      );

      // 注册登录按钮点击事件
      $("#login-button").click(function() {
        $.post(
          "/user/login",
          JSON.stringify({
            username: $("#username").val(),
            password: $("#password").val()
          }),
          function(data) {
            if(data.isError) {
              makeDialog(data.errorMessage);
            }else {
              Cookies.set("username", $("#username").val());
              Cookies.set("token", data.result.token);

              bootstrap();
            }
          },
          "json"
        );
      });

      $("#forget-button").click(function() {
        makeForgetForm();
      });
    }

    // 生成修改密码框
    function makeForgetForm() {
      $("body").empty();

      $("body").addClass("background");
      $("body").append(
        "<div id=\"forget-form\">" +
        "<div id=\"wrapper\">" +
        "<input type=\"user\" id=\"user\" placeholder=\"请输入用户名\">" +
        "<input type=\"password\" id=\"oldPassword\" placeholder=\"请输入旧密码\">" +
        "<input type=\"password\" id=\"newPassword\" placeholder=\"请输入新密码\">" +
        "<div id=\"change-button\"></div>" +
        "<div id=\"return-button\"></div>" +
        "</div>" +
        "</div>" +
        "<div id=\"ground\"></div>"
      );

      $("#change-button").click(function() {
        $.post(
          "/user/modifyPassword",
          JSON.stringify({
            username: $("#user").val(),
            oldPassword: $("#oldPassword").val(),
            newPassword: $("#newPassword").val()
          }),
          function(data) {
            if(data.isError) {
              makeDialog(data.errorMessage);
            }else {
              makeLoginForm();
            }
          },
          "json"
        );
      });

      $("#return-button").click(function() {
        makeLoginForm()
      });
    }

    // 制作对话框
    function makeDialog(msg) {
      $("body").append(
        "<div class=\"dialog\">" +
        "<div class=\"dialog\-header\">" +
        "<div class=\"close\-button\"></div>" +
        "</div>" +
        "<div class=\"dialog\-body\">" +
        "<p>" + msg + "</p>" +
        "</div>"
      );

      $(".dialog").css("margin-top", 0 - $(".dialog").outerHeight() / 2);
      $(".dialog").css("margin-left", 0 - $(".dialog").outerWidth() / 2);
      $(".close-button").click(function() {
        $(".dialog").detach();
      });
    }

    // 启动游戏
    function bootstrap() {
      // 清除对话框
      $("body").empty();

      // 清除背景
      $("body").removeClass("background");

      // canvas container
      $("body").append("<div id=\"canvas\"></div>");

      // open WebSocket
      var socket = io();

      // emitting register message
      // socket.emit("register", JSON.stringify({
      //   username: Cookies.get("username"),
      //   token: Cookies.get("token")
      // }));

      // create a game object
      var game = new Phaser.Game(
        window.innerWidth,
        window.innerHeight,
        Phaser.AUTO,
        "canvas",
        {
          preload: preload,
          create: create,
          update: update,
          render: render
        }
      );

      function preload() {
        game.load.image("background", "/static/assets/main/background.png");
        game.load.image("usernameBar", "/static/assets/main/username.png");
        game.load.image("coinBar", "/static/assets/main/coin.png");
        game.load.image("timeBar", "/static/assets/main/time.png");
        game.load.image("bulletinBar", "/static/assets/main/bulletin.png");
        game.load.image("buttonGroupBackground", "/static/assets/main/btn_bg.png");
        game.load.image("readyButton", "/static/assets/main/ready.png");
        game.load.image("cancelButton", "/static/assets/main/cancel.png");
      }

      function create() {
        var displayWidth = window.innerWidth;
        var displayHeight = window.innerHeight;

        // main scene
        var mainScene = game.add.group();
        mainScene.x = 0;
        mainScene.y = 0;
        mainScene.z = 0;

        var totalHeight = 0;

        // background
        var backgroundImage = game.add.image(0, 0, "background");
        backgroundImage.width = displayWidth;
        backgroundImage.height = displayHeight;
        mainScene.add(backgroundImage);

        // header group
        var headerGroup = game.add.group(mainScene);
        headerGroup.x = 0;
        headerGroup.y = 0;
        headerGroup.z = 0;

        // username bar
        var usernameBar = game.add.image(12, 12, "usernameBar");
        usernameBar.width = displayWidth * 0.3;
        usernameBar.height = usernameBar.width / (228 / 65);
        headerGroup.add(usernameBar);

        // coin bar
        var coinBar = game.add.image(displayWidth * 0.7 - 12, 12, "coinBar");
        coinBar.width = displayWidth * 0.3;
        coinBar.height = coinBar.width / (250 / 68);
        headerGroup.add(coinBar);

        totalHeight += coinBar.height + 12;

        // time bar
        var timeBar = game.add.image((displayWidth * 0.5) / 2, totalHeight + 12, "timeBar");
        timeBar.width = displayWidth * 0.5;
        timeBar.height = timeBar.width / (445 / 113);
        mainScene.add(timeBar);

        totalHeight += timeBar.height + 12;

        // bulletin bar
        var bulletinBar = game.add.image((displayWidth * 0.4) / 2, totalHeight + 12, "bulletinBar");
        bulletinBar.width = displayWidth * 0.6;
        bulletinBar.height = bulletinBar.width / (525 / 750);
        mainScene.add(bulletinBar);

        totalHeight += bulletinBar.height + 12;

        // button group
        var buttonGroup = game.add.group(mainScene);
        buttonGroup.x = 0;
        buttonGroup.y = totalHeight;
        buttonGroup.z = 0;

        // button background
        var buttonGroupBackground = game.add.image((displayWidth * 0.6) / 2, 0 - (((displayWidth * 0.4) / (420 / 109)) / 2), "buttonGroupBackground");
        buttonGroupBackground.width = displayWidth * 0.4;
        buttonGroupBackground.height = buttonGroupBackground.width / (420 / 109);
        buttonGroup.add(buttonGroupBackground);

        // ready button
        var readyButton = game.add.button((displayWidth * 0.6) / 2 + 2, 0 - (((displayWidth * 0.2) / (207 / 100)) / 2), "readyButton");
        readyButton.width = displayWidth * 0.2;
        readyButton.height = readyButton.width / (207 / 100);
        buttonGroup.add(readyButton);

        // cancel button
        var cancelButton = game.add.button((displayWidth * 0.6) / 2 + readyButton.width - 2, 0 - (((displayWidth * 0.2) / (207 / 100)) / 2), "cancelButton");
        cancelButton.width = displayWidth * 0.2;
        cancelButton.height = cancelButton.width / (207 / 100);
        buttonGroup.add(cancelButton);
      }

      function update() {

      }

      function render() {

      }
    }
  </script>
</head>
<body>
</body>
</html>
